<div id="gemini-chat-container">
    <div id="chat-window" class="chat-hidden">
        <div id="chat-header">
            <span>Assistente IA</span>
            <button onclick="toggleChat()">Ã—</button>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input-area">
            <input type="text" id="user-input" placeholder="Digite sua mensagem...">
            <button id="send-btn">âž¤</button>
        </div>
    </div>

    <div id="chat-button" onclick="toggleChat()">
        <span>ðŸ’¬</span>
    </div>
</div>

<style>
    #gemini-chat-container { font-family: sans-serif; z-index: 9999; position: relative; }
    #chat-button {
        position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px;
        background: #4285f4; border-radius: 50%; display: flex; align-items: center;
        justify-content: center; color: white; cursor: pointer; font-size: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    #chat-window {
        position: fixed; bottom: 90px; right: 20px; width: 350px; max-width: 85vw;
        height: 500px; background: white; border-radius: 15px; overflow: hidden;
        display: flex; flex-direction: column; box-shadow: 0 5px 25px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    .chat-hidden { display: none !important; }
    #chat-header { background: #4285f4; color: white; padding: 15px; display: flex; justify-content: space-between; font-weight: bold; }
    #chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .msg { padding: 8px 12px; border-radius: 10px; max-width: 80%; }
    .user { align-self: flex-end; background: #e3effd; color: #1a73e8; }
    .bot { align-self: flex-start; background: #f1f3f4; color: #3c4043; }
    #chat-input-area { border-top: 1px solid #eee; padding: 10px; display: flex; }
    #user-input { flex: 1; border: none; outline: none; padding: 5px; }
    #send-btn { background: none; border: none; cursor: pointer; font-size: 20px; }
</style>

<script>
    const chatWindow = document.getElementById('chat-window');
    const messagesContainer = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    function toggleChat() {
        chatWindow.classList.toggle('chat-hidden');
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        appendMessage('user', text);
        userInput.value = '';

        // Adiciona um balÃ£o de "Pensando..." para feedback visual
        const typingId = "typing-" + Date.now();
        appendMessage('bot', '...', typingId);

        try {
            const response = await fetch('http://localhost:5000/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });

            const data = await response.json();

            // Remove o balÃ£o de "Pensando..."
            document.getElementById(typingId)?.remove();

            // Se a ponte retornou vÃ¡rias partes (ex: "OlÃ¡" e depois o "Link")
            if (data.replies && data.replies.length > 0) {
                for (let i = 0; i < data.replies.length; i++) {
                    // Se for a segunda mensagem em diante, dÃ¡ um delay de 800ms
                    if (i > 0) await new Promise(r => setTimeout(r, 800));
                    appendMessage('bot', data.replies[i]);
                }
            }

        } catch (error) {
            document.getElementById(typingId)?.remove();
            appendMessage('bot', 'Erro na conexÃ£o.');
        }
    }

    function appendMessage(sender, text) {
        const div = document.createElement('div');
        div.classList.add('msg', sender);
        div.innerText = text;
        messagesContainer.appendChild(div);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    sendBtn.onclick = sendMessage;
    userInput.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
</script>